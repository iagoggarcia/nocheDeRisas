<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/x-icon" href="./images/icon.ico">
    <link rel="apple-touch-icon" href="./images/unnamed.png">
    <title>Noche CG</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="styles.css" rel="stylesheet">
    <script src="Palabras.js"></script>

</head>
<body>

    <div class="header-section">
        <img src="images/unnamed.png" width="300" style="filter: drop-shadow(0 0 10px var(--neon-cyan));">
        <h1>IMPOSTOR CG</h1>
    </div>

    <div class="main-container">
        <div id="setup-screen">            
            <label>Número de Jugadores</label>
            <div class="player-selector">
                <button class="selector-btn" onclick="changePlayers(-1)">-</button>
                <input type="number" id="total-players" value="4" min="3" max="20" readonly>
                <button class="selector-btn" onclick="changePlayers(1)">+</button>
            </div>

            <div id="names-container" style="margin-bottom: 20px;"></div>

            <label>Número de Impostores</label>
            <div class="player-selector" style="margin-bottom: 30px;">
                <button class="selector-btn" onclick="changeImpostors(-1)">-</button>
                <input type="text" id="total-impostors" value="1" readonly>
                <button class="selector-btn" onclick="changeImpostors(1)">+</button>
            </div>
            
            <button class="btn-main" onclick="startGame()">INICIAR PARTIDA</button>
        </div>

        <div id="game-screen" class="hidden">
            <div class="player-info" id="player-title">JUGADOR 1</div>
            <p style="text-align: center; color: var(--text-gray);">Pasa el móvil y pulsa para ver tu rol.</p>
            
            <div id="word-card" class="animate__animated"></div>
            
            <button id="action-btn" class="btn-main" onclick="handleTurn()">VER SECRETO</button>
            <p class="hint-text">No dejes que nadie más vea la pantalla.</p>
        </div>
    </div>

    <script>
        let playersData = [];
        let playerNames = []; // lista para guardar nombres
        let currentIndex = 0;
        let isRevealed = false;

        // Llamamos a esta función al cargar para que salgan los inputs iniciales
        window.onload = updateNameInputs;

        function changePlayers(delta) {
            const input = document.getElementById('total-players');
            let newValue = parseInt(input.value) + delta;
            if (newValue >= 3 && newValue <= 20) {
                input.value = newValue;
                updateNameInputs(); // Actualizamos inputs de nombres al cambiar número
            }
        }

        function updateNameInputs() {
            const count = parseInt(document.getElementById('total-players').value);
            const container = document.getElementById('names-container');
            
            // Guardamos los nombres que ya estén escritos antes de limpiar
            const currentNames = [];
            for(let i=0; i < 20; i++) {
                const el = document.getElementById(`name-${i}`);
                if(el) currentNames.push(el.value);
            }

            container.innerHTML = ''; 

            for (let i = 1; i <= count; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `Nombre Jugador ${i}`;
                input.className = 'player-name-input';
                input.id = `name-${i-1}`;
                // Si ya había un nombre escrito para esta posición, lo mantenemos
                input.value = currentNames[i-1] || ''; 
                container.appendChild(input);
            }
        }

        function changeImpostors(delta) {
            const input = document.getElementById('total-impostors');
            const numPlayers = parseInt(document.getElementById('total-players').value);
            
            // Si es "RANDOM", al pulsar lo reseteamos a número
            let current = input.value === "?" ? 0 : parseInt(input.value);
            let newValue = current + delta;

            // Límites: mínimo 1, máximo (jugadores - 1). Si pasas del máximo, ponemos RANDOM (?)
            if (newValue < 1) {
                input.value = "?"; // Representa Aleatorio
            } else if (newValue >= numPlayers) {
                input.value = numPlayers - 1; // No pueden ser todos impostores
            } else {
                input.value = newValue;
            }
        }

        // Modifica la función startGame para repartir varios impostores
        function startGame() {
            const numPlayers = parseInt(document.getElementById('total-players').value);
            const impostorInput = document.getElementById('total-impostors').value;
            
            // Determinar cuántos impostores habrá
            let numImpostors;
            if (impostorInput === "?") {
                // Aleatorio entre 1 y la mitad de los jugadores
                numImpostors = Math.floor(Math.random() * (numPlayers / 2)) + 1;
            } else {
                numImpostors = parseInt(impostorInput);
            }

            // Guardar nombres
            playerNames = [];
            for (let i = 0; i < numPlayers; i++) {
                const val = document.getElementById(`name-${i}`).value;
                playerNames.push(val.trim() || `Jugador ${i + 1}`);
            }
            
            const secretWord = BIBLIOTECA_PALABRAS[Math.floor(Math.random() * BIBLIOTECA_PALABRAS.length)];
            
            // Creo la lista de roles
            playersData = Array(numPlayers).fill(secretWord);
            
            // Repartir impostores en posiciones aleatorias únicas
            let assigned = 0;
            while (assigned < numImpostors) {
                let pos = Math.floor(Math.random() * numPlayers);
                if (playersData[pos] !== "IMPOSTOR") {
                    playersData[pos] = "IMPOSTOR";
                    assigned++;
                }
            }

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            showTurn();
        }

        function showTurn() {
            isRevealed = false;
            // Actualizamos el nombre del jugador actual
            document.getElementById('player-title').innerText = playerNames[currentIndex].toUpperCase();
            
            const card = document.getElementById('word-card');
            card.innerText = ''; // Limpiamos el texto anterior
            card.style.display = 'none'; // Ocultamos la tarjeta hasta que se pulse el botón
            
            // Limpiamos TODAS las clases de animación y colores previos
            card.className = 'animate__animated'; 
            
            document.getElementById('action-btn').innerText = 'VER SECRETO';
        }

        function handleTurn() {
            const card = document.getElementById('word-card');
            const btn = document.getElementById('action-btn');

            if (!isRevealed) {
                const content = playersData[currentIndex];
                card.innerText = content;
                card.style.display = 'block';
                
                // Quitamos clases viejas antes de poner las nuevas
                card.classList.remove('card-normal', 'card-impostor', 'animate__pulse', 'animate__fadeIn');
                
                if (content === "IMPOSTOR") {
                    card.classList.add('card-impostor', 'animate__pulse');
                } else {
                    card.classList.add('card-normal', 'animate__fadeIn');
                }

                btn.innerText = 'ENTENDIDO, SIGUIENTE';
                isRevealed = true;
            } else {
                currentIndex++;
                if (currentIndex < playersData.length) {
                    showTurn();
                } else {
                    finishGame();
                }
            }
        }

        function finishGame() {
        // innerHTML borra todo lo anterior del game-screen
        document.getElementById('game-screen').innerHTML = `
            <div style="display: flex; flex-direction: column; justify-content: center; height: 100%;">
            <h2 style="text-align:center; color: var(--neon-cyan); font-family: 'Orbitron'; margin-bottom: 20px;">¡A DEBATIR!</h2>
            <p style="text-align:center; color: var(--text-gray); margin-bottom: 30px;">Todos conocen su identidad. <br>¿Quién es el infiltrado?</p>
            <button class="btn-main" onclick="resetGame()">NUEVA PARTIDA</button>
        </div>
    `;
}

    function resetGame() {
            // Reiniciamos variables de control
            currentIndex = 0;
            isRevealed = false;
            playersData = [];

            // Restauramos el contenido original de la pantalla de juego para la próxima vez
            document.getElementById('game-screen').innerHTML = `
                <div class="player-info" id="player-title">JUGADOR 1</div>
                <p style="text-align: center; color: var(--text-gray);">Pasa el móvil y pulsa para ver tu rol.</p>
                <div id="word-card" class="animate__animated"></div>
                <button id="action-btn" class="btn-main" onclick="handleTurn()">VER SECRETO</button>
                <p class="hint-text">No dejes que nadie más vea la pantalla.</p>
            `;

            // Cambiamos de pantalla volviendo al setup (los nombres siguen ahí)
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
        }
    </script>

    <div class="stars-container">
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
</div>
</body>

</html>